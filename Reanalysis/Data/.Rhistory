left_join(
letters_df %>%
mutate(
DEPTH_key = normalize_depth(as.numeric(DEPTH_val)),
Species   = as.character(Species),
variable  = as.character(variable)
) %>%
dplyr::select(Species, variable, DEPTH_key, cld),
by = c("Species", "variable", "DEPTH_key")
)
View(letters_df)
View(FIRe_ave_long_no_out)
View(FIRe_ave_long_no_out)
label_df <- FIRe_ave_long_no_out %>%
mutate(
DEPTH_key = normalize_depth(DEPTH),
Species   = as.character(Species),
variable  = as.character(variable)
) %>%
group_by(Species, variable, DEPTH_key) %>%
summarise(y = max(responses, na.rm = TRUE), .groups = "drop") %>%
group_by(Species, variable) %>%
mutate(
# offset per panel (works even with free_y)
y = y + 0.05 * diff(range(y, na.rm = TRUE))
) %>%
ungroup() %>%
left_join(
letters_df %>%
mutate(
DEPTH_key = normalize_depth(as.numeric(DEPTH_val)),
Species   = as.character(Species),
variable  = as.character(variable)
) %>%
dplyr::select(Species, variable, DEPTH_key, cld),
by = c("Species", "variable", "DEPTH_key")
)
normalize_depth <- function(x) {
x <- as.character(x)
x <- trimws(x)
x
}
str(letters_df)
letters_df$DEPTH_val <- gsub("DEPTH", "", letters_df$DEPTH)
label_df <- FIRe_ave_long_no_out %>%
mutate(
DEPTH_key = normalize_depth(DEPTH),
Species   = as.character(Species),
variable  = as.character(variable)
) %>%
group_by(Species, variable, DEPTH_key) %>%
summarise(y = max(responses, na.rm = TRUE), .groups = "drop") %>%
group_by(Species, variable) %>%
mutate(
# offset per panel (works even with free_y)
y = y + 0.05 * diff(range(y, na.rm = TRUE))
) %>%
ungroup() %>%
left_join(
letters_df %>%
mutate(
DEPTH_key = normalize_depth(as.numeric(DEPTH_val)),
Species   = as.character(Species),
variable  = as.character(variable)
) %>%
dplyr::select(Species, variable, DEPTH_key, cld),
by = c("Species", "variable", "DEPTH_key")
)
FIRe_ave_long_no_out$Species=factor(FIRe_ave_long_no_out$Species, levels=c("Stylophora", "Porites", "Pocillopora", "Leptoseris"))
label_df$Species=factor(label_df$Species, levels=c("Stylophora", "Porites", "Pocillopora", "Leptoseris") )
letters_df$Species=factor(letters_df$Species, levels=c("Stylophora", "Porites", "Pocillopora", "Leptoseris") )
levels(FIRe_ave_long_no_out$variable)
FIRe_ave_long_no_out$variable=factor(FIRe_ave_long_no_out$variable, levels=c("fv_fm", "Pmax", "p", "Sigma"))
label_df$variable=factor(label_df$variable, levels=c("fv_fm", "Pmax", "p", "Sigma"))
library(ggh4x)
install.packages("ggh4x")
library(ggh4x)
ggplot(FIRe_ave_long_no_out, aes(x = as.factor(DEPTH), y = responses)) +
geom_boxplot(outlier.shape = NA, aes(fill=Species)) +
scale_fill_manual(values=c("#aa87deff","#3d8abdff", "#a69c68ff", "#8aca6bff" ))+
geom_text(
data = label_df %>% filter(!is.na(cld)),
aes(x = as.factor(DEPTH_key), y = y, label = cld),
inherit.aes = FALSE,
vjust = 0
) +
facet_grid(variable~Species, scales = "free") +
labs(x = "DEPTH", y = "responses")+
facetted_pos_scales(
y = list(
variable == "fv_fm" ~ scale_y_continuous(limits = c(0, 0.8)),
variable == "Pmax"  ~ scale_y_continuous(limits = c(0, 450)),
variable == "p"    ~ scale_y_continuous(limits = c(0, 0.45)),
variable == "Sigma" ~ scale_y_continuous(limits = c(100, 800))
)
)
setwd("/Users/talimass/Documents/Documents - MacBook Pro/GitHub/Coral-communities-along-the-depth-gradient-in-the-Red-Sea-reefs-of-Eilat/Reanalysis/Data")
fire=read.csv("FIRe_averaged_122025_1.csv", header=TRUE,  stringsAsFactors = TRUE)
str(fire)
fire$ID=paste(fire$Species, fire$Colony, fire$DEPTH, fire$SITE, sep="_")
str(fire)
row.names(fire)=fire$ID
fire_1=fire[!is.na(fire$p),]
#Leptoseris
Leptoseris=fire_1[fire_1$Species=="Leptoseris",]
dim(Leptoseris)
Leptoseris.pca=PCA(Leptoseris[,c(10:13)], scale.unit = TRUE, ncp = 10, graph = TRUE)
library(FactoMineR)
library(factoextra)
library(viridis)
library(ggpubr)
library(gridExtra)
str(fire)
fire$ID=paste(fire$Species, fire$Colony, fire$DEPTH, fire$SITE, sep="_")
str(fire)
row.names(fire)=fire$ID
fire_1=fire[!is.na(fire$p),]
#Leptoseris
Leptoseris=fire_1[fire_1$Species=="Leptoseris",]
dim(Leptoseris)
Leptoseris.pca=PCA(Leptoseris[,c(10:13)], scale.unit = TRUE, ncp = 10, graph = TRUE)
Leptoseris_fviz_coord=as.data.frame(Leptoseris.pca$ind$coord)
Leptoseris_base_biplot <- fviz_pca_biplot(
Leptoseris.pca,
invisible = "ind", # This makes the individuals invisible
label = "var",
repel = TRUE,
title = "Leptoseris",
col.var = "black"
)
Leptoseris_final_biplot <- Leptoseris_base_biplot +
geom_point(data=Leptoseris_fviz_coord, aes(x=Dim.1, y=Dim.2, size=as.factor(Leptoseris$of_live), alpha=as.factor(Leptoseris$of_live)), shape=19, color="#8aca6bff" ) +
#scale_shape_manual(values=c(21,22,24))+
scale_size_manual(values=c(1.5,2.5,3.5),labels = c("25m (0.7%)", "35m (2.6%)", "45m (2.9%)"))+
scale_alpha_manual(values=c(1,0.7,0.5),labels = c("25m (0.7%)", "35m (2.6%)", "45m (2.9%)"))+
scale_fill_viridis(option="G", discrete = TRUE, direction=-1)+
guides(fill=guide_legend(override.aes=list(shape=21)))+
theme_minimal()+
theme(legend.title = element_blank())
Leptoseris_final_biplot
#Pocillopora
Pocillopora=fire_1[fire_1$Species=="Pocillopora",]
dim(Pocillopora)
Pocillopora.pca=PCA(Pocillopora[,10:13], scale.unit = TRUE, ncp = 10, graph = TRUE)
Pocillopora_fviz_coord=as.data.frame(Pocillopora.pca$ind$coord)
Pocillopora_base_biplot <- fviz_pca_biplot(
Pocillopora.pca,
invisible = "ind", # This makes the individuals invisible
label = "var",
repel = TRUE,
title = "Pocillopora",
col.var="black"
)
Pocillopora_final_biplot <- Pocillopora_base_biplot +
geom_point(data=Pocillopora_fviz_coord, aes(x=Dim.1, y=Dim.2, size=as.factor(Pocillopora$of_live), alpha=as.factor(Pocillopora$of_live)), shape=19, color="#a69c68ff" ) +
#scale_shape_manual(values=c(21,22,24),)+
scale_size_manual(values=c(1.5,2.5,3.5),labels = c("5m (1.0%)", "15m (2.3%)", "25m (2.9%)"))+
scale_alpha_manual(values=c(1,0.7,0.5),labels = c("5m (1.0%)", "15m (2.3%)", "25m (2.9%)"))+
scale_fill_viridis(option="G", discrete = TRUE, direction=-1)+
guides(fill=guide_legend(override.aes=list(shape=21)))+
theme_minimal()+
theme(legend.title = element_blank())
Pocillopora_final_biplot
# Porites
Porites=fire_1[fire_1$Species=="Porites",]
dim(Porites)
Porites.pca=PCA(Porites[,10:13], scale.unit = TRUE, ncp = 10, graph = TRUE)
print(Porites.pca)
fviz_screeplot(Porites.pca, ncp=10)
plot.PCA(Porites.pca, axes = c(1,2), choix="ind")
fviz_pca_biplot(Porites.pca,  geom = "text")
Porites_fviz_coord=as.data.frame(Porites.pca$ind$coord)
Porites.pca$ind$coord
Porites_base_biplot <- fviz_pca_biplot(
Porites.pca,
invisible = "ind", # This makes the individuals invisible
label = "var",
repel = TRUE,
title = "Porites",
col.var="black"
)
str(Porites)
unique(log2(Porites$of_live))
Porites_final_biplot <- Porites_base_biplot +
geom_point(data=Porites_fviz_coord, aes(x=Dim.1, y=Dim.2, size=as.factor(Porites$of_live), alpha=as.factor(Porites$of_live)), shape=19, color="#3d8abdff" ) +
#scale_shape_manual(values=c(21,22,24))+
scale_size_manual(values=c(1.5,2.2,2.5,3,3.5),labels = c("5m (0.34%)", "15m (2.5%)", "25m (3.6%)", "35m (5.1%)", "45m (7.7%)"))+
scale_alpha_manual(values=c(1,0.8,0.6,0.5,0.4), labels = c("5m (0.34%)", "15m (2.5%)", "25m (3.6%)", "35m (5.1%)", "45m (7.7%)"))+
scale_fill_viridis(option="G", discrete = TRUE, direction=-1)+
guides(fill=guide_legend(override.aes=list(shape=21)))+
theme_minimal()+
theme(legend.title = element_blank())
Porites_final_biplot
# Stylophora
Stylophora=fire_1[fire_1$Species=="Stylophora",]
dim(Stylophora)
Stylophora.pca=PCA(Stylophora[,10:13], scale.unit = TRUE, ncp = 10, graph = TRUE)
print(Stylophora.pca)
fviz_screeplot(Stylophora.pca, ncp=10)
plot.PCA(Stylophora.pca, axes = c(1,2), choix="ind")
fviz_pca_biplot(Stylophora.pca,  geom = "text")
Stylophora_fviz_coord=as.data.frame(Stylophora.pca$ind$coord)
Stylophora_base_biplot <- fviz_pca_biplot(
Stylophora.pca,
invisible = "ind", # This makes the individuals invisible
label = "var",
repel = TRUE,
title = "Stylophora",
col.var="black"
)
str(Stylophora)
unique(Stylophora$of_live)
Stylophora_final_biplot <- Stylophora_base_biplot +
geom_point(data=Stylophora_fviz_coord, aes(x=Dim.1, y=Dim.2, size=as.factor(Stylophora$of_live), alpha=as.factor(Stylophora$of_live)), shape=19, color="#aa87deff" ) +
#scale_shape_manual(values=c(21,22,24))+
scale_size_manual(values=c(1.5,2.2,2.5,3,3.5),labels = c("5m (1.6%)", "15m (2.3%)", "25m (2.9%)", "35m (6.8%)", "45m (7.4%)"))+
scale_alpha_manual(values=c(1,0.8,0.6,0.5,0.4),labels = c("5m (1.6%)", "15m (2.3%)", "25m (2.9%)", "35m (6.8%)", "45m (7.4%)"))+
scale_fill_viridis(option="G", discrete = TRUE, direction=-1)+
guides(fill=guide_legend(override.aes=list(shape=21)))+
theme_minimal()+
theme(legend.title = element_blank())
Stylophora_final_biplot
library(patchwork)
p=(Stylophora_final_biplot | Porites_final_biplot) /
(Pocillopora_final_biplot | Leptoseris_final_biplot)
install.packages("patchwork")
library(patchwork)
p=(Stylophora_final_biplot | Porites_final_biplot) /
(Pocillopora_final_biplot | Leptoseris_final_biplot)
ggplot2::ggsave(
filename = "FIRe_PCA_biplots.svg",
plot     = p,
width    = 12,
height   = 10,
units    = "in"
)
0
p
ggplot(FIRe_ave_long_no_out, aes(x = as.factor(DEPTH), y = responses)) +
geom_boxplot(outlier.shape = NA, aes(fill=Species)) +
scale_fill_manual(values=c("#aa87deff","#3d8abdff", "#a69c68ff", "#8aca6bff" ))+
geom_text(
data = label_df %>% filter(!is.na(cld)),
aes(x = as.factor(DEPTH_key), y = y, label = cld),
inherit.aes = FALSE,
vjust = 0
) +
facet_grid(variable~Species, scales = "free") +
labs(x = "DEPTH", y = "responses")+
facetted_pos_scales(
y = list(
variable == "fv_fm" ~ scale_y_continuous(limits = c(0, 0.8)),
variable == "Pmax"  ~ scale_y_continuous(limits = c(0, 450)),
variable == "p"    ~ scale_y_continuous(limits = c(0, 0.45)),
variable == "Sigma" ~ scale_y_continuous(limits = c(100, 800))
)
)+
theme(axis.title.x = element_text(colour="Black", size=14),
axis.title.y = element_text(colour="Black", size=14),
axis.text.x = element_text(size=12),
axis.text.y = element_text(size=12),
legend.title = element_text(size=14),
legend.text = element_text(size=14),
legend.position = c(1,1), # legend position in the top right of plot area
legend.justification = c(1,1), # legend position inside the plot area
panel.grid.major = element_blank(), # Remove major grid lines
panel.grid.minor = element_blank()  # Remove minor grid lines
)
ggplot(FIRe_ave_long_no_out, aes(x = as.factor(DEPTH), y = responses)) +
geom_boxplot(outlier.shape = NA, aes(fill=Species)) +
scale_fill_manual(values=c("#aa87deff","#3d8abdff", "#a69c68ff", "#8aca6bff" ))+
geom_text(
data = label_df %>% filter(!is.na(cld)),
aes(x = as.factor(DEPTH_key), y = y, label = cld),
inherit.aes = FALSE,
vjust = 0
) +
facet_grid(variable~Species, scales = "free") +
labs(x = "DEPTH", y = "responses")+
facetted_pos_scales(
y = list(
variable == "fv_fm" ~ scale_y_continuous(limits = c(0, 0.8)),
variable == "Pmax"  ~ scale_y_continuous(limits = c(0, 450)),
variable == "p"    ~ scale_y_continuous(limits = c(0, 0.45)),
variable == "Sigma" ~ scale_y_continuous(limits = c(100, 800))
)
)+
theme_bw()
ggplot(FIRe_ave_long_no_out, aes(x = as.factor(DEPTH), y = responses)) +
geom_boxplot(outlier.shape = NA, aes(fill=Species)) +
scale_fill_manual(values=c("#aa87deff","#3d8abdff", "#a69c68ff", "#8aca6bff" ))+
geom_text(
data = label_df %>% filter(!is.na(cld)),
aes(x = as.factor(DEPTH_key), y = y, label = cld),
inherit.aes = FALSE,
vjust = 0
) +
facet_grid(variable~Species, scales = "free") +
labs(x = "DEPTH", y = "responses")+
facetted_pos_scales(
y = list(
variable == "fv_fm" ~ scale_y_continuous(limits = c(0, 0.8)),
variable == "Pmax"  ~ scale_y_continuous(limits = c(0, 450)),
variable == "p"    ~ scale_y_continuous(limits = c(0, 0.45)),
variable == "Sigma" ~ scale_y_continuous(limits = c(100, 800))
)
)+
theme_bw()+
theme(axis.title.x = element_text(colour="Black", size=14),
axis.title.y = element_text(colour="Black", size=14),
axis.text.x = element_text(size=12),
axis.text.y = element_text(size=12),
#legend.title = element_text(size=14),
#legend.text = element_text(size=14),
#legend.position = c(1,1), # legend position in the top right of plot area
#legend.justification = c(1,1), # legend position inside the plot area
panel.grid.major = element_blank(), # Remove major grid lines
panel.grid.minor = element_blank()  # Remove minor grid lines
)
#######
library(cowplot)
library(ggplot2)
# ---- combine ----
combined_pca <- plot_grid(
Leptoseris_final_biplot,
Pocillopora_final_biplot,
Porites_final_biplot,
Stylophora_final_biplot,
labels = c("A","B","C","D"),
ncol = 2,
label_size = 14,
label_fontface = "bold",
label_x = 0.02,
label_y = 0.98,
hjust = 0,
vjust = 1
)
# ---- output folder ----
output_dir <- "/Users/talimass/Documents/Documents - MacBook Pro/GitHub/Coral-communities-along-the-depth-gradient-in-the-Red-Sea-reefs-of-Eilat/Reanalysis/Output"
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
# ---- reset devices ----
graphics.off()
# ---- save (try PNG) ----
ggsave(
filename = file.path(output_dir, "PCA_combined_biplots.png"),
plot = combined_pca,
width = 10,
height = 7,
dpi = 300
)
# ---- save (PDF) ----
ggsave(
filename = file.path(output_dir, "PCA_combined_biplots.pdf"),
plot = combined_pca,
width = 10,
height = 7
)
# ---- open a new device and display ----
quartz()
print(combined_pca)
# ---- combine ----
combined_pca <- plot_grid(
Stylophora_final_biplot, Porites_final_biplot, Pocillopora_final_biplot, Leptoseris_final_biplot,
labels = c("A","B","C","D"),
ncol = 2,
label_size = 14,
label_fontface = "bold",
label_x = 0.02,
label_y = 0.98,
hjust = 0,
vjust = 1
)
# ---- output folder ----
output_dir <- "/Users/talimass/Documents/Documents - MacBook Pro/GitHub/Coral-communities-along-the-depth-gradient-in-the-Red-Sea-reefs-of-Eilat/Reanalysis/Output"
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
# ---- reset devices ----
graphics.off()
# ---- save (try PNG) ----
ggsave(
filename = file.path(output_dir, "PCA_combined_biplots.png"),
plot = combined_pca,
width = 10,
height = 7,
dpi = 300
)
# ---- save (PDF) ----
ggsave(
filename = file.path(output_dir, "PCA_combined_biplots.pdf"),
plot = combined_pca,
width = 10,
height = 7
)
# ---- open a new device and display ----
quartz()
print(combined_pca)
ggplot(FIRe_ave_long_no_out, aes(x = as.factor(DEPTH), y = responses)) +
geom_boxplot(outlier.shape = NA, aes(fill=Species)) +
scale_fill_manual(values=c("#aa87deff","#3d8abdff", "#a69c68ff", "#8aca6bff" ))+
geom_text(
data = label_df %>% filter(!is.na(cld)),
aes(x = as.factor(DEPTH_key), y = y, label = cld),
inherit.aes = FALSE,
vjust = 0
) +
facet_grid(variable~Species, scales = "free") +
labs(x = "DEPTH", y = "responses")+
facetted_pos_scales(
y = list(
variable == "fv_fm" ~ scale_y_continuous(limits = c(0, 0.8)),
variable == "Pmax"  ~ scale_y_continuous(limits = c(0, 450)),
variable == "p"    ~ scale_y_continuous(limits = c(0, 0.45)),
variable == "Sigma" ~ scale_y_continuous(limits = c(100, 800))
)
)+
theme_bw()+
theme(axis.title.x = element_text(colour="Black", size=14),
axis.title.y = element_text(colour="Black", size=14),
axis.text.x = element_text(size=12),
axis.text.y = element_text(size=12),
#legend.title = element_text(size=14),
#legend.text = element_text(size=14),
#legend.position = c(1,1), # legend position in the top right of plot area
#legend.justification = c(1,1), # legend position inside the plot area
panel.grid.major = element_blank(), # Remove major grid lines
panel.grid.minor = element_blank()  # Remove minor grid lines
)
##
output_dir <- "/Users/talimass/Documents/Documents - MacBook Pro/GitHub/Coral-communities-along-the-depth-gradient-in-the-Red-Sea-reefs-of-Eilat/Reanalysis/Output"
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
# ---- reset devices ----
graphics.off()
# ---- save (try PNG) ----
ggsave(
filename = file.path(output_dir, "FIRe_ave_long_no_out.png"),
plot = combined_pca,
width = 10,
height = 7,
dpi = 300
)
# ---- save (PDF) ----
ggsave(
filename = file.path(output_dir, "FIRe_ave_long_no_out.pdf"),
plot = combined_pca,
width = 10,
height = 7
)
##
output_dir <- "/Users/talimass/Documents/Documents - MacBook Pro/GitHub/Coral-communities-along-the-depth-gradient-in-the-Red-Sea-reefs-of-Eilat/Reanalysis/Output"
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
# ---- reset devices ----
graphics.off()
# ---- save (try PNG) ----
ggsave(
filename = file.path(output_dir, "FIRe_ave_long_no_out.png"),
plot = FIRe_ave_long_no_out,
width = 10,
height = 7,
dpi = 300
)
# ---- save (PDF) ----
ggsave(
filename = file.path(output_dir, "FIRe_ave_long_no_out.pdf"),
plot = combined_pca,
width = 10,
height = 7
)
p_fire <- ggplot(FIRe_ave_long_no_out, aes(x = as.factor(DEPTH), y = responses)) +
geom_boxplot(outlier.shape = NA, aes(fill=Species)) +
scale_fill_manual(values=c("#aa87deff","#3d8abdff", "#a69c68ff", "#8aca6bff" ))+
geom_text(
data = label_df %>% filter(!is.na(cld)),
aes(x = as.factor(DEPTH_key), y = y, label = cld),
inherit.aes = FALSE,
vjust = 0
) +
facet_grid(variable~Species, scales = "free") +
labs(x = "DEPTH", y = "responses")+
facetted_pos_scales(
y = list(
variable == "fv_fm" ~ scale_y_continuous(limits = c(0, 0.8)),
variable == "Pmax"  ~ scale_y_continuous(limits = c(0, 450)),
variable == "p"    ~ scale_y_continuous(limits = c(0, 0.45)),
variable == "Sigma" ~ scale_y_continuous(limits = c(100, 800))
)
)+
theme_bw()+
theme(axis.title.x = element_text(colour="Black", size=14),
axis.title.y = element_text(colour="Black", size=14),
axis.text.x = element_text(size=12),
axis.text.y = element_text(size=12),
panel.grid.major = element_blank(), # Remove major grid lines
panel.grid.minor = element_blank()  # Remove minor grid lines
)
print(p_fire)
##
output_dir <- "/Users/talimass/Documents/Documents - MacBook Pro/GitHub/Coral-communities-along-the-depth-gradient-in-the-Red-Sea-reefs-of-Eilat/Reanalysis/Output"
if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
# ---- Save as PNG ----
ggsave(
filename = file.path(output_dir, "FIRe_photophysiology_by_depth.png"),
plot = p_fire,
width = 12,
height = 8,
dpi = 300
)
# ---- Save as PDF (journal-ready) ----
ggsave(
filename = file.path(output_dir, "FIRe_photophysiology_by_depth.pdf"),
plot = p_fire,
width = 12,
height = 8
)
